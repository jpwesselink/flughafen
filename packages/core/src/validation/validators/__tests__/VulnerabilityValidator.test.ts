import { describe, expect, it, vi } from "vitest";
import { VulnerabilityValidator } from "../VulnerabilityValidator";
import type { ValidationContext, WorkflowValidationResult } from "../../types";

describe("VulnerabilityValidator", () => {
	const createContext = (content: string, filePath: string, options = {}): ValidationContext => ({
		content,
		filePath,
		options: { strict: false, verbose: false, silent: false, skipVulnerabilityCheck: false, ...options },
	});

	const createResult = (): WorkflowValidationResult => ({
		file: "",
		valid: true,
		errors: [],
		warnings: [],
	});

	describe("Action extraction", () => {
		it("should extract actions from YAML workflow", async () => {
			const validator = new VulnerabilityValidator();
			const context = createContext(
				`name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4`,
				"test.yml",
				{ skipVulnerabilityCheck: true } // Skip actual API call
			);
			const result = createResult();

			await validator.validate(context, result);

			// With skipVulnerabilityCheck, no errors should be added
			expect(result.errors).toHaveLength(0);
		});

		it("should extract actions from TypeScript workflow", async () => {
			const validator = new VulnerabilityValidator();
			const context = createContext(
				`import { createWorkflow } from '@flughafen/core';
export default createWorkflow()
  .name("Test")
  .on("push")
  .job("test", (job) => job
    .runsOn("ubuntu-latest")
    .step((step) => step.uses("actions/checkout@v4"))
    .step((step) => step.uses("actions/setup-node@v4"))
  );`,
				"test.ts",
				{ skipVulnerabilityCheck: true }
			);
			const result = createResult();

			await validator.validate(context, result);

			expect(result.errors).toHaveLength(0);
		});

		it("should skip validation when skipVulnerabilityCheck is true", async () => {
			const validator = new VulnerabilityValidator();
			const context = createContext(
				`name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4`,
				"test.yml",
				{ skipVulnerabilityCheck: true }
			);
			const result = createResult();

			await validator.validate(context, result);

			// No API calls should be made, no errors or warnings
			expect(result.errors).toHaveLength(0);
			expect(result.warnings).toHaveLength(0);
		});

		it("should handle workflow with no actions", async () => {
			const validator = new VulnerabilityValidator();
			const context = createContext(
				`name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - run: echo hello`,
				"test.yml"
			);
			const result = createResult();

			await validator.validate(context, result);

			// No actions to check, should pass
			expect(result.errors).toHaveLength(0);
		});

		it("should handle quoted action references in YAML", async () => {
			const validator = new VulnerabilityValidator();
			const context = createContext(
				`name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: "actions/checkout@v4"
      - uses: 'actions/setup-node@v4'`,
				"test.yml",
				{ skipVulnerabilityCheck: true }
			);
			const result = createResult();

			await validator.validate(context, result);

			expect(result.errors).toHaveLength(0);
		});

		it("should handle actions with SHA references", async () => {
			const validator = new VulnerabilityValidator();
			const context = createContext(
				`name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608`,
				"test.yml",
				{ skipVulnerabilityCheck: true }
			);
			const result = createResult();

			await validator.validate(context, result);

			expect(result.errors).toHaveLength(0);
		});
	});

	describe("API error handling", () => {
		it("should add warning when API fails", async () => {
			// Mock fetch to simulate API failure
			const originalFetch = global.fetch;
			global.fetch = vi.fn().mockRejectedValue(new Error("Network error"));

			const validator = new VulnerabilityValidator();
			const context = createContext(
				`name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4`,
				"test.yml"
			);
			const result = createResult();

			await validator.validate(context, result);

			// Should add warning about failed check
			expect(result.warnings).toHaveLength(1);
			expect(result.warnings[0].rule).toBe("vulnerability-check-error");

			global.fetch = originalFetch;
		});

		it("should add warning about rate limiting when unauthenticated", async () => {
			const originalFetch = global.fetch;
			const originalEnv = process.env.GITHUB_TOKEN;
			delete process.env.GITHUB_TOKEN;

			global.fetch = vi.fn().mockResolvedValue({
				ok: false,
				status: 403,
			});

			const validator = new VulnerabilityValidator();
			const context = createContext(
				`name: Test
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4`,
				"test.yml"
			);
			const result = createResult();

			await validator.validate(context, result);

			expect(result.warnings).toHaveLength(1);
			expect(result.warnings[0].message).toContain("GITHUB_TOKEN");

			global.fetch = originalFetch;
			if (originalEnv) process.env.GITHUB_TOKEN = originalEnv;
		});
	});
});
